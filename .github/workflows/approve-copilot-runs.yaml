# Auto-approve Copilot workflow runs
# GitHub blocks Copilot-authored events from triggering Actions (security policy).
# This workflow re-runs action_required runs from copilot-swe-agent every 15 min.
---
name: Approve Copilot Runs

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch: {}

jobs:
  approve:
    runs-on: ubicloud-standard-2
    steps:
      - name: Re-run action_required Copilot workflows
        env:
          GH_TOKEN: ${{ secrets.CLAUDE_REVIEW_GH_TOKEN }}
        run: |
          REPOS=(
            jai/trips
            jai/trips-api
            jai/trips-frontend
            jai/trips-email-ingest-worker
            jai/trips-infra
            jai/trips-fastlane
          )

          for repo in "${REPOS[@]}"; do
            echo "Checking $repo..."
            run_ids=$(gh api "repos/$repo/actions/runs?status=action_required&per_page=100" \
              --jq '.workflow_runs[].id' 2>/dev/null || true)

            if [[ -z "$run_ids" ]]; then
              echo "  No action_required runs"
              continue
            fi

            for run_id in $run_ids; do
              echo "  Re-running $run_id..."
              gh run rerun "$run_id" --repo "$repo" 2>&1 || true
            done
          done
