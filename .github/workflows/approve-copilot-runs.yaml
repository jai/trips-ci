# Auto-approve Copilot workflow runs
# GitHub blocks Copilot-authored events from triggering Actions (security policy).
# This workflow re-runs action_required runs from the last 24h across all Trips repos.
---
name: Approve Copilot Runs

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch: {}

jobs:
  approve:
    runs-on: ubicloud-standard-2
    steps:
      - name: Re-run recent action_required Copilot workflows
        env:
          GH_TOKEN: ${{ secrets.CLAUDE_REVIEW_GH_TOKEN }}
        run: |
          REPOS=(
            jai/trips
            jai/trips-api
            jai/trips-frontend
            jai/trips-email-ingest-worker
            jai/trips-infra
            jai/trips-fastlane
          )

          # Only look at runs from the last 24 hours
          SINCE=$(date -u -d '24 hours ago' '+%Y-%m-%dT%H:%M:%SZ')

          for repo in "${REPOS[@]}"; do
            echo "Checking $repo..."
            run_ids=$(gh api "repos/$repo/actions/runs?status=action_required&created=>=$SINCE&per_page=100" \
              --jq '.workflow_runs[].id' 2>/dev/null || true)

            if [[ -z "$run_ids" ]]; then
              echo "  No recent action_required runs"
              continue
            fi

            count=$(echo "$run_ids" | wc -l)
            echo "  Found $count runs to re-run"

            for run_id in $run_ids; do
              echo "  Re-running $run_id..."
              gh run rerun "$run_id" --repo "$repo" 2>&1 || true
            done
          done
