# Claude Code Review Router
# Thin dispatcher that routes incoming events to extracted reusable workflows.

---
name: Claude PR Assistant

on:
  workflow_call:
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true
      CLAUDE_REVIEW_GH_TOKEN:
        required: true

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: read

concurrency:
  group: code-review-${{ github.repository }}-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: false

jobs:
  welcome:
    name: Welcome comment (PR opened/reopened)
    if: |
      github.event_name == 'pull_request' &&
      (github.event.action == 'opened' || github.event.action == 'reopened')
    uses: ./.github/workflows/code-review-welcome.yaml
    secrets:
      GH_TOKEN: ${{ secrets.CLAUDE_REVIEW_GH_TOKEN }}

  full-review:
    name: Full code review
    if: |
      (
        github.event_name == 'pull_request' &&
        (
          github.event.action == 'opened' ||
          github.event.action == 'reopened' ||
          github.event.action == 'ready_for_review' ||
          github.event.action == 'synchronize' ||
          github.event.action == 'review_requested'
        )
      ) ||
      (
        github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        startsWith(github.event.comment.body, '/review')
      )
    uses: ./.github/workflows/code-review-full.yaml
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      CLAUDE_REVIEW_GH_TOKEN: ${{ secrets.CLAUDE_REVIEW_GH_TOKEN }}

  respond:
    name: Conversational / inline @claude response
    if: |
      (
        github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        contains(github.event.comment.body, '@claude') &&
        !startsWith(github.event.comment.body, '/')
      ) ||
      (
        github.event_name == 'pull_request_review_comment' &&
        contains(github.event.comment.body, '@claude')
      )
    uses: ./.github/workflows/code-review-respond.yaml
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      CLAUDE_REVIEW_GH_TOKEN: ${{ secrets.CLAUDE_REVIEW_GH_TOKEN }}

  ready-automation:
    name: Post-full-review ready automation
    needs: full-review
    if: needs.full-review.result == 'success'
    uses: ./.github/workflows/code-review-ready-automation.yaml
    with:
      ready: ${{ fromJSON(needs.full-review.outputs.ready || 'false') }}
      found: ${{ fromJSON(needs.full-review.outputs.found || 'false') }}
      pr_number: ${{ fromJSON(needs.full-review.outputs.pr_number || '0') }}
      head_sha: ${{ needs.full-review.outputs.head_sha }}
    secrets:
      CLAUDE_REVIEW_GH_TOKEN: ${{ secrets.CLAUDE_REVIEW_GH_TOKEN }}
